
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Computing NDVI &#8212; RasterFrames-Scala  documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }
</style>
<div class="section" id="Computing-NDVI">
<h1>Computing NDVI<a class="headerlink" href="#Computing-NDVI" title="Permalink to this headline">¶</a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-scala"><div class="highlight"><pre>
<span></span><span class="k">import</span> <span class="nn">astraea.spark.rasterframes._</span>
<span class="k">import</span> <span class="nn">geotrellis.raster._</span>
<span class="k">import</span> <span class="nn">geotrellis.raster.render._</span>
<span class="k">import</span> <span class="nn">geotrellis.raster.io.geotiff.SinglebandGeoTiff</span>
<span class="k">import</span> <span class="nn">geotrellis.spark._</span>
<span class="k">import</span> <span class="nn">geotrellis.spark.io._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions._</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">spark</span> <span class="k">=</span> <span class="nc">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">().</span>
  <span class="n">master</span><span class="o">(</span><span class="s">&quot;local[*]&quot;</span><span class="o">).</span><span class="n">appName</span><span class="o">(</span><span class="s">&quot;RasterFrames&quot;</span><span class="o">).</span><span class="n">getOrCreate</span><span class="o">().</span><span class="n">withRasterFrames</span>
<span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">setLogLevel</span><span class="o">(</span><span class="s">&quot;ERROR&quot;</span><span class="o">)</span>
<span class="k">import</span> <span class="nn">spark.implicits._</span>

<span class="k">val</span> <span class="n">scene</span> <span class="k">=</span> <span class="nc">SinglebandGeoTiff</span><span class="o">(</span><span class="s">&quot;samples/L8-B8-Robinson-IL.tiff&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">rf</span> <span class="k">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">projectedRaster</span><span class="o">.</span><span class="n">toRF</span><span class="o">(</span><span class="mi">128</span><span class="o">,</span> <span class="mi">128</span><span class="o">).</span><span class="n">cache</span><span class="o">()</span>
<span class="o">;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[6]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>import astraea.spark.rasterframes._
import geotrellis.raster._
import geotrellis.raster.render._
import geotrellis.raster.io.geotiff.SinglebandGeoTiff
import geotrellis.spark._
import geotrellis.spark.io._
import org.apache.spark.sql._
import org.apache.spark.sql.functions._
spark: org.apache.spark.sql.SparkSession = org.apache.spark.sql.SparkSession@23e27ab6
import spark.implicits._
scene: geotrellis.raster.io.geotiff.SinglebandGeoTiff = SinglebandGeoTiff(geotrellis.raster.UShortConstantNoDataArrayTile@21146da5,Extent(431902.5, 4313647.5, 443512.5, 4321147.5),EPSG:32616,Tags(Map(AREA_OR_POINT -&gt; POINT),List(Map())),GeoTiffOptions(geotrellis.raster.io.geotiff.Striped@8d8541f,geotrellis.raster.io.geotiff.compression.DeflateCompression$@a2379e4,1,None))
rf: org.apache.spark.sql.DataFrame ...
</pre></div>
</div>
</div>
<p>Here’s an example of computing the Normalized Differential Vegetation
Index (NDVI) is a standardized vegetation index which allows us to
generate an image highlighting differences in relative biomass.</p>
<blockquote>
<div>“An NDVI is often used worldwide to monitor drought, monitor and
predict agricultural production, assist in predicting hazardous fire
zones, and map desert encroachment. The NDVI is preferred for global
vegetation monitoring because it helps to compensate for changing
illumination conditions, surface slope, aspect, and other extraneous
factors” (Lillesand. <em>Remote sensing and image interpretation</em>.
2004).</div></blockquote>
<p>NDVI is the normalized difference of the nir and red bands:</p>
<div class="math">
\[NDVI = \frac{nir - red}{nir + red}\]</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-scala"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="n">redBand</span> <span class="k">=</span> <span class="nc">SinglebandGeoTiff</span><span class="o">(</span><span class="s">&quot;../samples/L8-B4-Elkton-VA.tiff&quot;</span><span class="o">).</span><span class="n">projectedRaster</span><span class="o">.</span><span class="n">toRF</span><span class="o">(</span><span class="s">&quot;red_band&quot;</span><span class="o">)</span>
<span class="k">def</span> <span class="n">nirBand</span> <span class="k">=</span> <span class="nc">SinglebandGeoTiff</span><span class="o">(</span><span class="s">&quot;../samples/L8-B5-Elkton-VA.tiff&quot;</span><span class="o">).</span><span class="n">projectedRaster</span><span class="o">.</span><span class="n">toRF</span><span class="o">(</span><span class="s">&quot;nir_band&quot;</span><span class="o">)</span>

<span class="c1">// Define UDF for computing NDVI from red and NIR bands</span>
<span class="k">val</span> <span class="n">ndvi</span> <span class="k">=</span> <span class="n">udf</span><span class="o">((</span><span class="n">red</span><span class="k">:</span> <span class="kt">Tile</span><span class="o">,</span> <span class="n">nir</span><span class="k">:</span> <span class="kt">Tile</span><span class="o">)</span> <span class="k">⇒</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">redd</span> <span class="k">=</span> <span class="n">red</span><span class="o">.</span><span class="n">convert</span><span class="o">(</span><span class="nc">DoubleConstantNoDataCellType</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">nird</span> <span class="k">=</span> <span class="n">nir</span><span class="o">.</span><span class="n">convert</span><span class="o">(</span><span class="nc">DoubleConstantNoDataCellType</span><span class="o">)</span>
  <span class="o">(</span><span class="n">nird</span> <span class="o">-</span> <span class="n">redd</span><span class="o">)/(</span><span class="n">nird</span> <span class="o">+</span> <span class="n">redd</span><span class="o">)</span>
<span class="o">})</span>

<span class="c1">// We use `asRF` to indicate we know the structure still conforms to RasterFrame constraints</span>
<span class="k">val</span> <span class="n">rf</span> <span class="k">=</span> <span class="n">redBand</span><span class="o">.</span><span class="n">spatialJoin</span><span class="o">(</span><span class="n">nirBand</span><span class="o">).</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;ndvi&quot;</span><span class="o">,</span> <span class="n">ndvi</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;red_band&quot;</span><span class="o">,</span> <span class="n">$</span><span class="s">&quot;nir_band&quot;</span><span class="o">)).</span><span class="n">asRF</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[2]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>redBand: astraea.spark.rasterframes.RasterFrame
nirBand: astraea.spark.rasterframes.RasterFrame
ndvi: org.apache.spark.sql.expressions.UserDefinedFunction = UserDefinedFunction(&lt;function2&gt;,org.apache.spark.sql.gt.types.TileUDT@29b43b46,Some(List(org.apache.spark.sql.gt.types.TileUDT@29b43b46, org.apache.spark.sql.gt.types.TileUDT@29b43b46)))
rf: astraea.spark.rasterframes.RasterFrame = [spatial_key: struct&lt;col: int, row: int&gt;, red_band: rf_tile ... 2 more fields]

</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-scala"><div class="highlight"><pre>
<span></span><span class="n">rf</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">tileStats</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;ndvi&quot;</span><span class="o">)).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+---------+--------------------+------------------+-------------------+--------------------+
|dataCells|                 min|               max|               mean|            variance|
+---------+--------------------+------------------+-------------------+--------------------+
|    31433|-0.12488999119929595|0.6699834571985877|0.45558948033745933|0.010907294541915387|
+---------+--------------------+------------------+-------------------+--------------------+

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-scala"><div class="highlight"><pre>
<span></span><span class="k">val</span> <span class="n">pr</span> <span class="k">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">toRaster</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;ndvi&quot;</span><span class="o">,</span> <span class="mi">466</span><span class="o">,</span> <span class="mi">428</span><span class="o">)</span>

<span class="k">val</span> <span class="n">brownToGreen</span> <span class="k">=</span> <span class="nc">ColorRamp</span><span class="o">(</span>
  <span class="nc">RGBA</span><span class="o">(</span><span class="mi">166</span><span class="o">,</span><span class="mi">97</span><span class="o">,</span><span class="mi">26</span><span class="o">,</span><span class="mi">255</span><span class="o">),</span>
  <span class="nc">RGBA</span><span class="o">(</span><span class="mi">223</span><span class="o">,</span><span class="mi">194</span><span class="o">,</span><span class="mi">125</span><span class="o">,</span><span class="mi">255</span><span class="o">),</span>
  <span class="nc">RGBA</span><span class="o">(</span><span class="mi">245</span><span class="o">,</span><span class="mi">245</span><span class="o">,</span><span class="mi">245</span><span class="o">,</span><span class="mi">255</span><span class="o">),</span>
  <span class="nc">RGBA</span><span class="o">(</span><span class="mi">128</span><span class="o">,</span><span class="mi">205</span><span class="o">,</span><span class="mi">193</span><span class="o">,</span><span class="mi">255</span><span class="o">),</span>
  <span class="nc">RGBA</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">133</span><span class="o">,</span><span class="mi">113</span><span class="o">,</span><span class="mi">255</span><span class="o">)</span>
<span class="o">).</span><span class="n">stops</span><span class="o">(</span><span class="mi">128</span><span class="o">)</span>

<span class="k">val</span> <span class="n">colors</span> <span class="k">=</span> <span class="nc">ColorMap</span><span class="o">.</span><span class="n">fromQuantileBreaks</span><span class="o">(</span><span class="n">pr</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">histogramDouble</span><span class="o">(),</span> <span class="n">brownToGreen</span><span class="o">)</span>
<span class="c1">// change writing location</span>
<span class="n">pr</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">color</span><span class="o">(</span><span class="n">colors</span><span class="o">).</span><span class="n">renderPng</span><span class="o">().</span><span class="n">write</span><span class="o">(</span><span class="s">&quot;target/scala-2.11/tut/apps/rf-ndvi.png&quot;</span><span class="o">)</span>

<span class="c1">//For a georefrenced singleband greyscale image, could do: `GeoTiff(pr).write(&quot;ndvi.tiff&quot;)`</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
java.io.FileNotFoundException: target/scala-2.11/tut/apps/rf-ndvi.png (No such file or directory)
  at java.io.FileOutputStream.open0(Native Method)
  at java.io.FileOutputStream.open(FileOutputStream.java:270)
  at java.io.FileOutputStream.&lt;init&gt;(FileOutputStream.java:213)
  at java.io.FileOutputStream.&lt;init&gt;(FileOutputStream.java:162)
  at geotrellis.raster.render.Png.write(ImageFormats.scala:36)
  ... 53 elided

</pre></div></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, James Nachbar.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/Minis/ndvi-scala.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>