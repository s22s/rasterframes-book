
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Clustering &#8212; rasterframes-book  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }
</style>
<div class="section" id="Clustering">
<h1>Clustering<a class="headerlink" href="#Clustering" title="Permalink to this headline">¶</a></h1>
<p>In this example we will do some simple cell clustering based on
multiband imagery.</p>
<div class="section" id="Setup">
<h2>Setup<a class="headerlink" href="#Setup" title="Permalink to this headline">¶</a></h2>
<p>First some setup:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-scala"><div class="highlight"><pre>
<span></span><span class="k">import</span> <span class="nn">astraea.spark.rasterframes._</span>
<span class="k">import</span> <span class="nn">astraea.spark.rasterframes.ml.TileExploder</span>
<span class="k">import</span> <span class="nn">geotrellis.raster.io.geotiff.SinglebandGeoTiff</span>
<span class="k">import</span> <span class="nn">geotrellis.raster._</span>
<span class="k">import</span> <span class="nn">geotrellis.raster.render._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.ml.Pipeline</span>
<span class="k">import</span> <span class="nn">org.apache.spark.ml.clustering.</span><span class="o">{</span><span class="nc">KMeans</span><span class="o">,</span> <span class="nc">KMeansModel</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.apache.spark.ml.feature.VectorAssembler</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql._</span>

<span class="c1">// Utility for reading imagery from our test data set</span>
<span class="k">def</span> <span class="n">readTiff</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">SinglebandGeoTiff</span> <span class="o">=</span> <span class="nc">SinglebandGeoTiff</span><span class="o">(</span><span class="s">s&quot;../samples/</span><span class="si">$name</span><span class="s">&quot;</span><span class="o">)</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">spark</span> <span class="k">=</span> <span class="nc">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">().</span>
  <span class="n">master</span><span class="o">(</span><span class="s">&quot;local[*]&quot;</span><span class="o">).</span><span class="n">appName</span><span class="o">(</span><span class="n">getClass</span><span class="o">.</span><span class="n">getName</span><span class="o">).</span><span class="n">getOrCreate</span><span class="o">().</span><span class="n">withRasterFrames</span>
<span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">setLogLevel</span><span class="o">(</span><span class="s">&quot;ERROR&quot;</span><span class="o">)</span>

<span class="k">import</span> <span class="nn">spark.implicits._</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[3]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>import astraea.spark.rasterframes._
import astraea.spark.rasterframes.ml.TileExploder
import geotrellis.raster.io.geotiff.SinglebandGeoTiff
import geotrellis.raster._
import geotrellis.raster.render._
import org.apache.spark.ml.Pipeline
import org.apache.spark.ml.clustering.{KMeans, KMeansModel}
import org.apache.spark.ml.feature.VectorAssembler
import org.apache.spark.sql._
readTiff: (name: String)geotrellis.raster.io.geotiff.SinglebandGeoTiff
spark: org.apache.spark.sql.SparkSession = org.apache.spark.sql.SparkSession@65bb2f1
import spark.implicits._

</pre></div>
</div>
</div>
</div>
<div class="section" id="Loading-Data">
<h2>Loading Data<a class="headerlink" href="#Loading-Data" title="Permalink to this headline">¶</a></h2>
<p>The first step is to load multiple bands of imagery and construct a
single RasterFrame from them.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-scala"><div class="highlight"><pre>
<span></span><span class="k">val</span> <span class="n">filenamePattern</span> <span class="k">=</span> <span class="s">&quot;L8-B%d-Elkton-VA.tiff&quot;</span>
<span class="k">val</span> <span class="n">bandNumbers</span> <span class="k">=</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">4</span>
<span class="k">val</span> <span class="n">bandColNames</span> <span class="k">=</span> <span class="n">bandNumbers</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">b</span> <span class="k">⇒</span> <span class="s">s&quot;band_</span><span class="si">$b</span><span class="s">&quot;</span><span class="o">).</span><span class="n">toArray</span>

<span class="c1">// For each identified band, load the associated image file, convert to a RasterFrame, and join</span>
<span class="k">val</span> <span class="n">joinedRF</span> <span class="k">=</span> <span class="n">bandNumbers</span><span class="o">.</span>
  <span class="n">map</span> <span class="o">{</span> <span class="n">b</span> <span class="k">⇒</span> <span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">filenamePattern</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">b</span><span class="o">))</span> <span class="o">}.</span>
  <span class="n">map</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">f</span><span class="o">)</span> <span class="k">⇒</span> <span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">readTiff</span><span class="o">(</span><span class="n">f</span><span class="o">))</span> <span class="o">}.</span>
  <span class="n">map</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">t</span><span class="o">)</span> <span class="k">⇒</span> <span class="n">t</span><span class="o">.</span><span class="n">projectedRaster</span><span class="o">.</span><span class="n">toRF</span><span class="o">(</span><span class="s">s&quot;band_</span><span class="si">$b</span><span class="s">&quot;</span><span class="o">)</span> <span class="o">}.</span>
  <span class="n">reduce</span><span class="o">(</span><span class="k">_</span> <span class="n">spatialJoin</span> <span class="k">_</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[4]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>filenamePattern: String = L8-B%d-Elkton-VA.tiff
bandNumbers: scala.collection.immutable.Range.Inclusive = Range(1, 2, 3, 4)
bandColNames: Array[String] = Array(band_1, band_2, band_3, band_4)
joinedRF: astraea.spark.rasterframes.RasterFrame = [spatial_key: struct&lt;col: int, row: int&gt;, band_1: rf_tile ... 3 more fields]

</pre></div>
</div>
</div>
<p>We should see a single <code class="docutils literal"><span class="pre">spatial_key</span></code> column along with 4 columns of
tiles.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-scala"><div class="highlight"><pre>
<span></span><span class="n">joinedRF</span><span class="o">.</span><span class="n">printSchema</span><span class="o">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ML-Pipeline">
<h2>ML Pipeline<a class="headerlink" href="#ML-Pipeline" title="Permalink to this headline">¶</a></h2>
<p>SparkML requires that each observation be in its own row, and those
observations be packed into a single <code class="docutils literal"><span class="pre">Vector</span></code>. The first step is to
“explode” the tiles into a single row per cell/pixel.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-scala"><div class="highlight"><pre>
<span></span><span class="k">val</span> <span class="n">exploder</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">TileExploder</span><span class="o">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[5]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>exploder: astraea.spark.rasterframes.ml.TileExploder = tile-exploder_9ea64c96fde0

</pre></div>
</div>
</div>
<p>To “vectorize” the the band columns, as required by SparkML, we use the
SparkML <code class="docutils literal"><span class="pre">VectorAssembler</span></code>. We then configure our algorithm, create the
transformation pipeline, and train our model. (Note: the selected value
of <em>K</em> below is arbitrary.)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-scala"><div class="highlight"><pre>
<span></span><span class="k">val</span> <span class="n">assembler</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">VectorAssembler</span><span class="o">().</span>
  <span class="n">setInputCols</span><span class="o">(</span><span class="n">bandColNames</span><span class="o">).</span>
  <span class="n">setOutputCol</span><span class="o">(</span><span class="s">&quot;features&quot;</span><span class="o">)</span>

<span class="c1">// Configure our clustering algorithm</span>
<span class="k">val</span> <span class="n">k</span> <span class="k">=</span> <span class="mi">5</span>
<span class="k">val</span> <span class="n">kmeans</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">KMeans</span><span class="o">().</span><span class="n">setK</span><span class="o">(</span><span class="n">k</span><span class="o">)</span>

<span class="c1">// Combine the two stages</span>
<span class="k">val</span> <span class="n">pipeline</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Pipeline</span><span class="o">().</span><span class="n">setStages</span><span class="o">(</span><span class="nc">Array</span><span class="o">(</span><span class="n">exploder</span><span class="o">,</span> <span class="n">assembler</span><span class="o">,</span> <span class="n">kmeans</span><span class="o">))</span>

<span class="c1">// Compute clusters</span>
<span class="k">val</span> <span class="n">model</span> <span class="k">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="o">(</span><span class="n">joinedRF</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[6]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>assembler: org.apache.spark.ml.feature.VectorAssembler = vecAssembler_cffd20eac427
k: Int = 5
kmeans: org.apache.spark.ml.clustering.KMeans = kmeans_78708a4e7fbe
pipeline: org.apache.spark.ml.Pipeline = pipeline_8d53c3f74ef7
model: org.apache.spark.ml.PipelineModel = pipeline_8d53c3f74ef7

</pre></div>
</div>
</div>
</div>
<div class="section" id="Model-Evaluation">
<h2>Model Evaluation<a class="headerlink" href="#Model-Evaluation" title="Permalink to this headline">¶</a></h2>
<p>At this point the model can be saved off for later use, or used
immediately on the same data we used to compute the model. First we run
the data through the model to assign cluster IDs to each cell.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-scala"><div class="highlight"><pre>
<span></span><span class="k">val</span> <span class="n">clustered</span> <span class="k">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="o">(</span><span class="n">joinedRF</span><span class="o">)</span>
<span class="n">clustered</span><span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">8</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+-----------+------------+---------+-------+------+------+------+--------------------+----------+
|spatial_key|column_index|row_index| band_1|band_2|band_3|band_4|            features|prediction|
+-----------+------------+---------+-------+------+------+------+--------------------+----------+
|      [0,0]|           0|        0| 9470.0|8491.0|7805.0|6697.0|[9470.0,8491.0,78...|         1|
|      [0,0]|           1|        0| 9566.0|8607.0|8046.0|6898.0|[9566.0,8607.0,80...|         1|
|      [0,0]|           2|        0| 9703.0|8808.0|8377.0|7222.0|[9703.0,8808.0,83...|         0|
|      [0,0]|           3|        0| 9856.0|8983.0|8565.0|7557.0|[9856.0,8983.0,85...|         0|
|      [0,0]|           4|        0|10105.0|9270.0|8851.0|7912.0|[10105.0,9270.0,8...|         0|
|      [0,0]|           5|        0|10273.0|9463.0|9196.0|8341.0|[10273.0,9463.0,9...|         2|
|      [0,0]|           6|        0| 9920.0|9077.0|8480.0|7534.0|[9920.0,9077.0,84...|         0|
|      [0,0]|           7|        0| 9559.0|8603.0|7847.0|6829.0|[9559.0,8603.0,78...|         1|
+-----------+------------+---------+-------+------+------+------+--------------------+----------+
only showing top 8 rows

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[7]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>clustered: org.apache.spark.sql.DataFrame = [spatial_key: struct&lt;col: int, row: int&gt;, column_index: int ... 7 more fields]

</pre></div>
</div>
</div>
<p>If we want to inspect the model statistics, the SparkML API requires us
to go through this unfortunate contortion:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-scala"><div class="highlight"><pre>
<span></span><span class="k">val</span> <span class="n">clusterResults</span> <span class="k">=</span> <span class="n">model</span><span class="o">.</span><span class="n">stages</span><span class="o">.</span><span class="n">collect</span><span class="o">{</span> <span class="k">case</span> <span class="n">km</span><span class="k">:</span> <span class="kt">KMeansModel</span> <span class="o">⇒</span> <span class="n">km</span><span class="o">}.</span><span class="n">head</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[8]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>clusterResults: org.apache.spark.ml.clustering.KMeansModel = kmeans_78708a4e7fbe

</pre></div>
</div>
</div>
<p>Compute sum of squared distances of points to their nearest center:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-scala"><div class="highlight"><pre>
<span></span><span class="k">val</span> <span class="n">metric</span> <span class="k">=</span> <span class="n">clusterResults</span><span class="o">.</span><span class="n">computeCost</span><span class="o">(</span><span class="n">clustered</span><span class="o">)</span>
<span class="n">println</span><span class="o">(</span><span class="s">&quot;Within set sum of squared errors: &quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Within set sum of squared errors: 1.0416215116259007E10
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[9]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>metric: Double = 1.0416215116259007E10

</pre></div>
</div>
</div>
</div>
<div class="section" id="Visualizing-Results">
<h2>Visualizing Results<a class="headerlink" href="#Visualizing-Results" title="Permalink to this headline">¶</a></h2>
<p>The predictions are in a DataFrame with each row representing a separate
pixel. To assemble a raster to visualize the cluster assignments, we
have to go through a multi-stage process to get the data back in tile
form, and from there to combined raster form.</p>
<p>First, we get the DataFrame back into RasterFrame form:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-scala"><div class="highlight"><pre>
<span></span><span class="k">val</span> <span class="n">tlm</span> <span class="k">=</span> <span class="n">joinedRF</span><span class="o">.</span><span class="n">tileLayerMetadata</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">get</span>

<span class="k">val</span> <span class="n">retiled</span> <span class="k">=</span> <span class="n">clustered</span><span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;spatial_key&quot;</span><span class="o">).</span><span class="n">agg</span><span class="o">(</span>
  <span class="n">assembleTile</span><span class="o">(</span>
    <span class="n">$</span><span class="s">&quot;column_index&quot;</span><span class="o">,</span> <span class="n">$</span><span class="s">&quot;row_index&quot;</span><span class="o">,</span> <span class="n">$</span><span class="s">&quot;prediction&quot;</span><span class="o">,</span>
    <span class="n">tlm</span><span class="o">.</span><span class="n">tileCols</span><span class="o">,</span> <span class="n">tlm</span><span class="o">.</span><span class="n">tileRows</span><span class="o">,</span> <span class="nc">ByteConstantNoDataCellType</span>
  <span class="o">)</span>
<span class="o">)</span>

<span class="k">val</span> <span class="n">rf</span> <span class="k">=</span> <span class="n">retiled</span><span class="o">.</span><span class="n">asRF</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;spatial_key&quot;</span><span class="o">,</span> <span class="n">tlm</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[10]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>tlm: geotrellis.spark.TileLayerMetadata[geotrellis.spark.SpatialKey] = TileLayerMetadata(uint16raw,GridExtent(Extent(703986.502389, 4249551.61978, 709549.093643, 4254601.8671),29.90640459139769,29.883120236686878),Extent(703986.502389, 4249551.61978, 709549.093643, 4254601.8671),utm-CS,KeyBounds(SpatialKey(0,0),SpatialKey(0,0)))
retiled: org.apache.spark.sql.DataFrame = [spatial_key: struct&lt;col: int, row: int&gt;, prediction: rf_tile]
rf: astraea.spark.rasterframes.RasterFrame = [spatial_key: struct&lt;col: int, row: int&gt;, prediction: rf_tile]

</pre></div>
</div>
</div>
<p>To render our visualization, we convert to a raster first, and then use
an <code class="docutils literal"><span class="pre">IndexedColorMap</span></code> to assign each discrete cluster a different
color, and finally rendering to a PNG file.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-scala"><div class="highlight"><pre>
<span></span><span class="k">val</span> <span class="n">predRaster</span> <span class="k">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">toRaster</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;prediction&quot;</span><span class="o">,</span> <span class="mi">186</span><span class="o">,</span> <span class="mi">169</span><span class="o">)</span>

<span class="k">val</span> <span class="n">clusterColors</span> <span class="k">=</span> <span class="nc">IndexedColorMap</span><span class="o">.</span><span class="n">fromColorMap</span><span class="o">(</span>
  <span class="nc">ColorRamps</span><span class="o">.</span><span class="nc">Viridis</span><span class="o">.</span><span class="n">toColorMap</span><span class="o">((</span><span class="mi">0</span> <span class="n">until</span> <span class="n">k</span><span class="o">).</span><span class="n">toArray</span><span class="o">)</span>
<span class="o">)</span>

<span class="n">raster</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">renderPng</span><span class="o">(</span><span class="n">clusterColors</span><span class="o">).</span><span class="n">write</span><span class="o">(</span><span class="s">&quot;outputs/clustered.png&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[12]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>raster: geotrellis.raster.ProjectedRaster[geotrellis.raster.Tile] = ProjectedRaster(Raster(CroppedTile(ByteConstantNoDataArrayTile([B@75a613f3,186,169),GridBounds(0,0,185,168)),Extent(703986.502389, 4249551.61978, 709549.093643, 4254601.8671)),utm-CS)
clusterColors: geotrellis.raster.render.IndexedColorMap = IndexedColorMap(0x440154ff, 0x3b528bff, 0x21918cff, 0x5cc863ff, 0xfde725ff)

</pre></div>
</div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="45%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Color Composite</th>
<th class="head">Cluster Assignments</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><img alt="image0" src="notebooks/Scala/outputs/L8-RGB-VA.png" /></td>
<td><img alt="image1" src="../../_images/clustered.png" /></td>
</tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, James Nachbar.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../../_sources/notebooks/Scala/clustering-scala.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>