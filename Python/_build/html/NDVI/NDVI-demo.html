
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>NDVI Case Study &#8212; rasterframes-book  documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Housing Case Study" href="../Housing/Housing.html" />
    <link rel="prev" title="RasterFrames Documentation" href="../index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }
</style>
<div class="section" id="NDVI-Case-Study">
<h1>NDVI Case Study<a class="headerlink" href="#NDVI-Case-Study" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Introduction:">
<h2>Introduction:<a class="headerlink" href="#Introduction:" title="Permalink to this headline">¶</a></h2>
<p>Rasterframes is a powerful tool for combining geospatial data and spark
dataframes. In this case study, we will walk through using rasterframes
to conduct analysis of a forested region to determine the extent of
deforestation using NDVI (Normalized Difference Vegetation Index)
combined with basic machine learning techniques available through
pysparkML. This tutorial assumes a basic knowledge of dataframes, more
info can be found
<a class="reference external" href="https://spark.apache.org/docs/latest/sql-programming-guide.html#datasets-and-dataframes">here</a>:</p>
</div>
<div class="section" id="Background:">
<h2>Background:<a class="headerlink" href="#Background:" title="Permalink to this headline">¶</a></h2>
<p>As humans expand across the planet, land that was once forested is
cleared for other activities such as farming or logging. Such land is
often high in biodiversity, and our forests are an essential feature in
our ecosystem, and the rate at which they are being destroyed is only
increasing. Gathering data on the rate of destruction as well as the
precise regions in which this destruction is occurring allows scientists
and authorities combat deforestation. Satellite data can be utilized to
track and prevent deforestation, as demonstrated by this tutorial, which
uses an example from the Amazon rainforest.</p>
</div>
<div class="section" id="Initializing-the-environment:">
<h2>Initializing the environment:<a class="headerlink" href="#Initializing-the-environment:" title="Permalink to this headline">¶</a></h2>
<p>First, some imports must be made. The rasterframes library must be
imported as well as pyspark, which serves as the processing backbone of
rasterframes.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pyrasterframes</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyrasterframes.rasterfunctions</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">pyspark</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="k">import</span> <span class="n">SparkSession</span>
</pre></div>
</div>
</div>
<p>Once the imports have been made, a <code class="docutils literal"><span class="pre">sparkSession</span></code> must be created.
Note the <code class="docutils literal"><span class="pre">withRasterFrames()</span></code> method that is called which enables
access to the rasterframes API.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span> \
    <span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[*]&quot;</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">appName</span><span class="p">(</span><span class="s2">&quot;RasterFrames&quot;</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.ui.enabled&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">getOrCreate</span><span class="p">()</span><span class="o">.</span> \
    <span class="n">withRasterFrames</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Reading-in-a-Rasterframe">
<h2>Reading in a Rasterframe<a class="headerlink" href="#Reading-in-a-Rasterframe" title="Permalink to this headline">¶</a></h2>
<p>Once everything has been initialized, the next step is to read in our
data. This example will use data in the form of a GeoTiff, but there are
other ways to create a rasterframe, including from a geotrellis
<code class="docutils literal"><span class="pre">Layer</span></code>, <code class="docutils literal"><span class="pre">ProjectedExtent</span></code>, or <code class="docutils literal"><span class="pre">tileLayerRDD</span></code> (see
[creating-rasterframes] for more info). In the case of a geotiff, it’s
as simple as pointing spark.read.geotiff to the input file(s).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># add multiple tiffs</span>
<span class="n">filePath</span> <span class="o">=</span> <span class="s1">&#39;data/brazil_1/band2.tif&#39;</span>
<span class="n">initRF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">geotiff</span><span class="p">(</span><span class="n">filePath</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Initial-analysis">
<h2>Initial analysis<a class="headerlink" href="#Initial-analysis" title="Permalink to this headline">¶</a></h2>
<p>Immediately, we can perform some basic functions on this rasterframe. A
brief <code class="docutils literal"><span class="pre">rf.show()</span></code> will demonstrate that a rasterframe is very similar
to a dataframe, with named columns corresponding to certain attributes.
For instance, <code class="docutils literal"><span class="pre">tile</span></code> contains all the cell values of the image.
<code class="docutils literal"><span class="pre">bounds</span></code> contains the bounds of the tiff’s geometry, etc. In this way,
a tiff raster can be represented as a rasterframe.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">initRF</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+-----------+--------------------+--------------------+--------------------+
|spatial_key|              bounds|            metadata|                tile|
+-----------+--------------------+--------------------+--------------------+
|      [0,0]|POLYGON ((746445 ...|Map(Band_1 -&gt; ban...|ShortUserDefinedN...|
+-----------+--------------------+--------------------+--------------------+

</pre></div></div>
</div>
<p>We can conduct some initial analysis on the tile by calling
<code class="docutils literal"><span class="pre">tileStats</span></code> on the tile. The output is an array with the number of
cells, number of noDataCells, min, max, mean, and variance respectively.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">initRF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">tileStats</span><span class="p">(</span><span class="s2">&quot;tile&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+----------------------------------------------------------+
|tileStats(tile)                                           |
+----------------------------------------------------------+
|[51525,-1,125.0,726.0,237.8598544395925,4944.952683336407]|
+----------------------------------------------------------+

</pre></div></div>
</div>
<p>We can examine the cell type of a tile with the <code class="docutils literal"><span class="pre">cellType</span></code> command.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">initRF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cellType</span><span class="p">(</span><span class="s2">&quot;tile&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+------------------------+
|celltypeexpression(tile)|
+------------------------+
|int16ud-9999            |
+------------------------+

</pre></div></div>
</div>
<p>Individual stats about a tile can be obtained through the family of
methods including <code class="docutils literal"><span class="pre">tileMean</span></code>, <code class="docutils literal"><span class="pre">tileSum</span></code>, <code class="docutils literal"><span class="pre">tileMin</span></code>, etc. You’ll
notice the output of <code class="docutils literal"><span class="pre">tileMean</span></code> is consistent with the mean value
found with <code class="docutils literal"><span class="pre">tileStats</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">initRF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">tileMean</span><span class="p">(</span><span class="s2">&quot;tile&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+------------------+
|    tileMean(tile)|
+------------------+
|237.85985443959243|
+------------------+

</pre></div></div>
</div>
</div>
<div class="section" id="Loading-the-rest-of-the-bands">
<h2>Loading the rest of the bands<a class="headerlink" href="#Loading-the-rest-of-the-bands" title="Permalink to this headline">¶</a></h2>
<p>This image is a multiband image, but we are going to load in each band
individually and then perform a spatial join on the bands. This allows
us to get all the bands in one rasterframe. For this demo, we are using
visual and near infrared light to calculate NDVI and perform
unsupervised clustering on the dataset. This means that we are loading
in bands 2 through 5, which correspond to Blue, Green, Red, and NIR on
the <a class="reference external" href="https://lta.cr.usgs.gov/L8">Landsat 8 OLI</a>. <code class="docutils literal"><span class="pre">spatialJoin</span></code> is a
dataframe join that joins according to a spatial_key column. Bounds and
metadata are discarded because they are no longer useful for the
project.</p>
<p>This project analyzes three seperate scenes, all captured in close
proximity to each other in the Brazilian rainforest. The background of
this image is the green band, and it seems obvious from a brief look at
this band that there is deforestation occurring at all three sites.</p>
<div class="figure" id="id1">
<img alt="Pic" src="../_images/site_locs.png" />
<p class="caption"><span class="caption-text">Pic</span></p>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Three scenes</span>
<span class="n">sceneNums</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="c1"># Four bands per scene (2, 3, 4, and 5)</span>
<span class="n">bandNums</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

<span class="n">filePattern</span> <span class="o">=</span> <span class="s1">&#39;data/brazil_</span><span class="si">{0}</span><span class="s1">/band</span><span class="si">{1}</span><span class="s1">.tif&#39;</span>

<span class="k">def</span> <span class="nf">readTiff</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">geotiff</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>

<span class="c1">#Start from the bottom</span>

<span class="c1"># Join those singleband rasterframes together into a multiband RF</span>
<span class="n">fullRFs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sn</span><span class="p">:</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rf1</span><span class="p">,</span> <span class="n">rf2</span><span class="p">:</span> <span class="n">rf1</span><span class="o">.</span><span class="n">asRF</span><span class="p">()</span><span class="o">.</span><span class="n">spatialJoin</span><span class="p">(</span><span class="n">rf2</span><span class="p">),</span>
                  <span class="c1"># Map those tuples to the singleband rasterframe file with the default &quot;tile&quot; column renamed</span>
                  <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bf</span><span class="p">:</span> <span class="n">readTiff</span><span class="p">(</span><span class="n">bf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> \
                      <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s1">&#39;tile&#39;</span><span class="p">,</span> <span class="s1">&#39;band_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bf</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
                  <span class="c1"># Map the bandNumbers to (bandNumber, formatted file name) tuples</span>
                  <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">bn</span><span class="p">:</span> <span class="p">(</span><span class="n">bn</span><span class="p">,</span> <span class="n">filePattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="n">bn</span><span class="p">)),</span> <span class="n">bandNums</span><span class="p">)))</span> \
                      <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;bounds&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">),</span> <span class="n">sceneNums</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>As you can see, all four bands of all three scenes are now loaded into
three seperate rasterframes.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [432]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">rf</span> <span class="ow">in</span> <span class="n">fullRFs</span><span class="p">:</span>
    <span class="n">rf</span><span class="o">.</span><span class="n">asRF</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+-----------+--------------------+--------------------+--------------------+--------------------+
|spatial_key|              band_2|              band_3|              band_4|              band_5|
+-----------+--------------------+--------------------+--------------------+--------------------+
|      [0,0]|ShortUserDefinedN...|ShortUserDefinedN...|ShortUserDefinedN...|ShortUserDefinedN...|
+-----------+--------------------+--------------------+--------------------+--------------------+

+-----------+--------------------+--------------------+--------------------+--------------------+
|spatial_key|              band_2|              band_3|              band_4|              band_5|
+-----------+--------------------+--------------------+--------------------+--------------------+
|      [0,0]|ShortUserDefinedN...|ShortUserDefinedN...|ShortUserDefinedN...|ShortUserDefinedN...|
+-----------+--------------------+--------------------+--------------------+--------------------+

+-----------+--------------------+--------------------+--------------------+--------------------+
|spatial_key|              band_2|              band_3|              band_4|              band_5|
+-----------+--------------------+--------------------+--------------------+--------------------+
|      [0,0]|ShortUserDefinedN...|ShortUserDefinedN...|ShortUserDefinedN...|ShortUserDefinedN...|
+-----------+--------------------+--------------------+--------------------+--------------------+

</pre></div></div>
</div>
<p>In addition, it is possible to display the center of the extent of the
tile in (Lat, Long) format. The method <code class="docutils literal"><span class="pre">withCenter</span></code> will display it in
the native CRS, and <code class="docutils literal"><span class="pre">withBounds</span></code> and <code class="docutils literal"><span class="pre">withSpatialIndex</span></code> also exist.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [433]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">rf</span> <span class="ow">in</span> <span class="n">fullRFs</span><span class="p">:</span>
    <span class="n">rf</span><span class="o">.</span><span class="n">asRF</span><span class="p">()</span><span class="o">.</span><span class="n">withCenterLatLng</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;center&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+---------------------------------------+
|center                                 |
+---------------------------------------+
|[-66.72875437318221,-8.829838122908235]|
+---------------------------------------+

+---------------------------------------+
|center                                 |
+---------------------------------------+
|[-66.96294012022688,-8.904540118090805]|
+---------------------------------------+

+---------------------------------------+
|center                                 |
+---------------------------------------+
|[-66.89073947264485,-8.725024074332008]|
+---------------------------------------+

</pre></div></div>
</div>
</div>
<div class="section" id="Tile-arithmetic">
<h2>Tile arithmetic<a class="headerlink" href="#Tile-arithmetic" title="Permalink to this headline">¶</a></h2>
<p>This example uses
<a class="reference external" href="https://earthobservatory.nasa.gov/Features/MeasuringVegetation/measuring_vegetation_2.php">NDVI</a>,
which is a metric computed from the normalized difference between two of
our bands, the NIR band (band 5), and the red band (band 4). We will add
another column, this time with the tiles as the normalized difference
between the NIR and red bands for each scene. In addition, it is
sometimes useful to compute additional relationships between bands to
use as features in a machine learning algorithm. Additionally, the cell
types of the NIR and red bands are converted to floats for the purposes
of stability with <code class="docutils literal"><span class="pre">convertCellType</span></code>, which changes the data type of
the cells in a tile.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">ndviRFs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rf</span><span class="p">:</span> <span class="n">rf</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;ndvi&quot;</span><span class="p">,</span> \
        <span class="n">normalizedDifference</span><span class="p">(</span><span class="n">convertCellType</span><span class="p">(</span><span class="s1">&#39;band_5&#39;</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="n">convertCellType</span><span class="p">(</span><span class="s1">&#39;band_4&#39;</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">))),</span> <span class="n">fullRFs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Normalized difference is a local function that is equivalent to
<span class="math">\(\frac{NIR - Red}{NIR + Red}\)</span>. Local functions perform functions
on a cellwise basis. Every cell in a band has corresponding cells in
another band, and the output of a local function is a tile where the
cell values are determined by some function that operates on every cell
individually. We will find the sum of the green and blue bands to use in
our clustering model. <code class="docutils literal"><span class="pre">localAdd</span></code> is part of a family of arithemtic
functions, and it adds the values of every corresponding cell together
to produce an output cell. There also exist local scalar arithmetic
functions, which you must append “Int” to to use with an integer.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">gbRFs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rf</span><span class="p">:</span> <span class="n">rf</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;green+blue&quot;</span><span class="p">,</span> <span class="n">localAdd</span><span class="p">(</span><span class="s2">&quot;band_3&quot;</span><span class="p">,</span> <span class="s2">&quot;band_2&quot;</span><span class="p">)),</span> <span class="n">ndviRFs</span><span class="p">))</span>
<span class="n">g2RFs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rf</span><span class="p">:</span> <span class="n">rf</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;green*2&quot;</span><span class="p">,</span> <span class="n">localMultiplyScalarInt</span><span class="p">(</span><span class="s2">&quot;band_3&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">gbRFs</span><span class="p">))</span>
<span class="n">completedRFs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rf</span><span class="p">:</span> <span class="n">rf</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;NIR-blue&quot;</span><span class="p">,</span> <span class="n">localSubtract</span><span class="p">(</span><span class="s2">&quot;band_5&quot;</span><span class="p">,</span> <span class="s2">&quot;band_2&quot;</span><span class="p">)),</span> <span class="n">g2RFs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">rf</span> <span class="ow">in</span> <span class="n">completedRFs</span><span class="p">:</span>
    <span class="n">rf</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">tileStats</span><span class="p">(</span><span class="s2">&quot;ndvi&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+----------------------------------------------------------------------------------------+
|tileStats(ndvi)                                                                         |
+----------------------------------------------------------------------------------------+
|[51525,-1,0.2584196925163269,0.9273137450218201,0.8077649412792555,0.008396342462181239]|
+----------------------------------------------------------------------------------------+

+---------------------------------------------------------------------------------------+
|tileStats(ndvi)                                                                        |
+---------------------------------------------------------------------------------------+
|[57072,-1,-0.5266343951225281,0.914093017578125,0.7854701653986633,0.01124415954480573]|
+---------------------------------------------------------------------------------------+

+-----------------------------------------------------------------------------------------+
|tileStats(ndvi)                                                                          |
+-----------------------------------------------------------------------------------------+
|[54285,-1,-0.22884012758731842,0.918924868106842,0.7426226493763454,0.012297012799279415]|
+-----------------------------------------------------------------------------------------+

</pre></div></div>
</div>
</div>
<div class="section" id="Machine-learning">
<h2>Machine learning<a class="headerlink" href="#Machine-learning" title="Permalink to this headline">¶</a></h2>
<p>The purpose of this demonstration is to determine the extent of
deforestation in the selected areas in a procedural way. To this end, we
will use a straightforward
<a class="reference external" href="https://en.wikipedia.org/wiki/K-means_clustering">k-means</a>
clustering algorithm available to us through PySparkML.</p>
<div class="section" id="Pipeline">
<h3>Pipeline<a class="headerlink" href="#Pipeline" title="Permalink to this headline">¶</a></h3>
<p>The algorithm works through assigning features to clusters. PySparkML
requires that each feature be in its own row, and those features be
packed into a single <code class="docutils literal"><span class="pre">Vector</span></code>. This means that all the information
must be packed into a single feature vector. The first step is to
“explode” the tiles into a single row per cell/pixel, so the top left
cell is assigned its own row, with the cellwise values of every band as
the values in that row.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">exploder</span> <span class="o">=</span> <span class="n">TileExploder</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">bandColNames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;band_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">bandNums</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>The next step is for the cell values in their seperate columns to be
assembled into a single feature vector. PySparkML has a tool for this
called a <code class="docutils literal"><span class="pre">VectorAssembler</span></code> which has as inputs a certain number of
columns of features and outputs a single column with the vectorized
features in it.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="k">import</span> <span class="n">VectorAssembler</span>

<span class="n">assembler</span> <span class="o">=</span> <span class="n">VectorAssembler</span><span class="p">()</span> \
    <span class="o">.</span><span class="n">setInputCols</span><span class="p">(</span><span class="n">bandColNames</span> <span class="o">+</span> <span class="p">[(</span><span class="s2">&quot;ndvi&quot;</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[(</span><span class="s2">&quot;green+blue&quot;</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[(</span><span class="s2">&quot;green*2&quot;</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[(</span><span class="s2">&quot;NIR-blue&quot;</span><span class="p">)])</span> \
    <span class="o">.</span><span class="n">setOutputCol</span><span class="p">(</span><span class="s2">&quot;features&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>For our example we are setting the number of clusters to 2, because we
seek simply to differentiate between forested area and non forested
area.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pyspark.ml.clustering</span> <span class="k">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">pyspark.ml</span> <span class="k">import</span> <span class="n">Pipeline</span>

<span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">()</span><span class="o">.</span><span class="n">setK</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># We establish our pipeline with our stages</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">()</span><span class="o">.</span><span class="n">setStages</span><span class="p">([</span><span class="n">exploder</span><span class="p">,</span> <span class="n">assembler</span><span class="p">,</span> <span class="n">kmeans</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Finally, we fit our model and compute our clusters</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rf</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">rf</span><span class="p">),</span> <span class="n">completedRFs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Upon fitting the model and transforming the data, we see the exploded
data. Instead of a tile, every entry in a band contain a single pixel
value. In addition, there is a prediction column that contains the
result of the model’s clustering.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">rfModelZip</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">completedRFs</span><span class="p">,</span> <span class="n">models</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">clusteredRFs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rfmd</span><span class="p">:</span> <span class="n">rfmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rfmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">rfModelZip</span><span class="p">))</span>
<span class="n">clusteredRFs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+-----------+------------+---------+------+------+------+------+------------------+----------+-------+--------+--------------------+----------+
|spatial_key|column_index|row_index|band_2|band_3|band_4|band_5|              ndvi|green+blue|green*2|NIR-blue|            features|prediction|
+-----------+------------+---------+------+------+------+------+------------------+----------+-------+--------+--------------------+----------+
|      [0,0]|           0|        0| 188.0| 349.0| 206.0|2750.0|0.8606224656105042|     537.0|  698.0|  2562.0|[188.0,349.0,206....|         0|
|      [0,0]|           1|        0| 184.0| 340.0| 207.0|2837.0|0.8639947175979614|     524.0|  680.0|  2653.0|[184.0,340.0,207....|         0|
|      [0,0]|           2|        0| 196.0| 356.0| 227.0|2856.0|0.8527408242225647|     552.0|  712.0|  2660.0|[196.0,356.0,227....|         0|
+-----------+------------+---------+------+------+------+------+------------------+----------+-------+--------+--------------------+----------+
only showing top 3 rows

</pre></div></div>
</div>
<p>In order to visualize the predictions of our model, we must first
convert the exploded version of the tile back into an actual tile.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">tiledRFs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
    <span class="n">tlm</span> <span class="o">=</span> <span class="n">completedRFs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">asRF</span><span class="p">()</span><span class="o">.</span><span class="n">tileLayerMetadata</span><span class="p">()</span>
    <span class="n">layout</span> <span class="o">=</span> <span class="n">tlm</span><span class="p">[</span><span class="s1">&#39;layoutDefinition&#39;</span><span class="p">][</span><span class="s1">&#39;tileLayout&#39;</span><span class="p">]</span>

    <span class="n">retiled</span> <span class="o">=</span> <span class="n">clusteredRFs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;spatial_key&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">assembleTile</span><span class="p">(</span><span class="s1">&#39;column_index&#39;</span><span class="p">,</span> <span class="s1">&#39;row_index&#39;</span><span class="p">,</span> <span class="s1">&#39;prediction&#39;</span><span class="p">,</span>
        <span class="n">layout</span><span class="p">[</span><span class="s1">&#39;tileCols&#39;</span><span class="p">],</span> <span class="n">layout</span><span class="p">[</span><span class="s1">&#39;tileRows&#39;</span><span class="p">],</span> <span class="s1">&#39;int16&#39;</span><span class="p">))</span>

    <span class="n">tiledRFs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">retiled</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">predRFs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rf</span><span class="p">:</span> <span class="n">rf</span><span class="o">.</span><span class="n">asRF</span><span class="p">(</span><span class="s1">&#39;spatial_key&#39;</span><span class="p">,</span> <span class="n">tlm</span><span class="p">),</span> <span class="n">tiledRFs</span><span class="p">))</span>
<span class="k">for</span> <span class="n">rf</span> <span class="ow">in</span> <span class="n">predRFs</span><span class="p">:</span>
    <span class="n">rf</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+-----------+--------------------+
|spatial_key|          prediction|
+-----------+--------------------+
|      [0,0]|ShortConstantNoDa...|
+-----------+--------------------+

+-----------+--------------------+
|spatial_key|          prediction|
+-----------+--------------------+
|      [0,0]|ShortConstantNoDa...|
+-----------+--------------------+

+-----------+--------------------+
|spatial_key|          prediction|
+-----------+--------------------+
|      [0,0]|ShortConstantNoDa...|
+-----------+--------------------+

</pre></div></div>
</div>
<p>To render our visualization, we convert to a raster first, which gives
us a 1-D array with all the cell values. We then reshape the raster into
a 2d array and use an matplotlib colormap to assign each discrete
cluster a different color.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Why do I have to switch the resolutions every time?</span>
<span class="n">resolutions</span> <span class="o">=</span> <span class="p">((</span><span class="mi">229</span><span class="p">,</span> <span class="mi">225</span><span class="p">),</span> <span class="p">(</span><span class="mi">232</span><span class="p">,</span> <span class="mi">246</span><span class="p">),</span> <span class="p">(</span><span class="mi">235</span><span class="p">,</span> <span class="mi">231</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Zip the prediction RFs and their respective resolutions to prepare to render them</span>
<span class="n">zipPredsRes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">predRFs</span><span class="p">,</span> <span class="n">resolutions</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Create a one dimensional array from the prediction data</span>
<span class="c1"># toIntRaster takes so long</span>
<span class="n">predRaster</span> <span class="o">=</span> <span class="n">zipPredsRes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">toIntRaster</span><span class="p">(</span><span class="s1">&#39;prediction&#39;</span><span class="p">,</span> <span class="n">zipPredsRes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">zipPredsRes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># toIntRaster takes so long</span>
<span class="c1"># Create a one dimensional array from the prediction data</span>
<span class="n">rasters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">PdsRes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">PdsRes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">toIntRaster</span><span class="p">(</span><span class="s1">&#39;prediction&#39;</span><span class="p">,</span> <span class="n">PdsRes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">PdsRes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))),</span> <span class="n">zipPredsRes</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Zip the prediction RFs and their respective resolutions to prepare to render them</span>
<span class="n">zipRasterResolution</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">rasters</span><span class="p">,</span> <span class="n">resolutions</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">pixels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">RasRes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">RasRes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">RasRes</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">zipRasterResolution</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">pixels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[48]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>array([[2, 2, 2, ..., 0, 0, 0],
       [2, 2, 2, ..., 0, 0, 0],
       [1, 2, 2, ..., 0, 0, 0],
       ...,
       [0, 0, 0, ..., 0, 0, 0],
       [0, 0, 0, ..., 0, 0, 0],
       [0, 0, 0, ..., 0, 0, 0]])
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="k">as</span> <span class="nn">mpimg</span>

<span class="c1"># Plot the images</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;YlGn_r&quot;</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
<span class="c1"># Flip the colormap because the last scene has the cluster values reversed</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;YlGn&quot;</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pixels</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">pixels4</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s2">&quot;pics/brazil1-green.png&quot;</span><span class="p">)</span>
<span class="n">imgplot</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pixels4</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">pixels4</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s2">&quot;pics/brazil2-green.png&quot;</span><span class="p">)</span>
<span class="n">imgplot</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pixels4</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">pixels4</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s2">&quot;pics/brazil3-green.png&quot;</span><span class="p">)</span>
<span class="n">imgplot</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pixels4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/NDVI_NDVI-demo_49_0.png" src="../_images/NDVI_NDVI-demo_49_0.png" />
</div>
</div>
<p>As you can see, the dark green represents forest, with the other two
shades representing land that is cleared to some degree. Now let’s
access more precise statistics about this use.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">predRFs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">tileHistogram</span><span class="p">(</span><span class="s2">&quot;prediction&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+--------------------------------------------------------------------------------------------------------------+
|tileHistogram(prediction)                                                                                     |
+--------------------------------------------------------------------------------------------------------------+
|[[54285,-1,0.0,2.0,0.7729391176199687,0.7130744692600854],WrappedArray([0.0,26917], [1.0,12777], [2.0,14591])]|
+--------------------------------------------------------------------------------------------------------------+

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">predRFs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">tileHistogram</span><span class="p">(</span><span class="s2">&quot;prediction&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+--------------------------------------------------------------------------------------------------------------+
|tileHistogram(prediction)                                                                                     |
+--------------------------------------------------------------------------------------------------------------+
|[[51525,-1,0.0,2.0,0.8065405143134401,0.6496185511242382],WrappedArray([0.0,22684], [1.0,16125], [2.0,12716])]|
+--------------------------------------------------------------------------------------------------------------+

</pre></div></div>
</div>
<p>In these examples, it appears that a value of zero (Dark Green in the
colormap) represents forest. Let’s find the percentage of land covered
by forest in these examples. Recall that rasters is the list of one
dimensional arrays containing all the prediction values for the three
scenes.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Returns the number of cells that we believe the model marked similarly to forest</span>
<span class="n">forest1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">rasters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">forest2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">rasters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="c1"># The third scene has the clusters reversed, so we look for values of 2</span>
<span class="n">forest3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">rasters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>In the first scene, a little less than half of the scene is composed of
the values that resemble rainforest (according to the model).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Number of forest divided by the total</span>
<span class="n">forest1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">rasters</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[70]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>0.44025230470645316
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Total forest cells for all three scenes, divided by total cells</span>
<span class="p">(</span><span class="n">forest1</span> <span class="o">+</span> <span class="n">forest2</span> <span class="o">+</span> <span class="n">forest3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rasters</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">rasters</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">rasters</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[71]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>0.39488709618005674
</pre></div>
</div>
</div>
<p>In total, it appears that less than 40 percent of the area surveyed in
these three scenes is forested. While there are improvements to be made,
this algorithm could easily be adapted to survey land of any size.
Landsat 8 has a temporal resolution of 16 days, and tracking these
numbers over time could give an estimate of the rate of change of
deforestation in a certain area, or with enough compute power, the
entire Amazon Rainforest.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="../index.html" title="previous chapter">RasterFrames Documentation</a></li>
      <li>Next: <a href="../Housing/Housing.html" title="next chapter">Housing Case Study</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, James Nachbar.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/NDVI/NDVI-demo.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>